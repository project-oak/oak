#!/usr/bin/env bash

readonly SCRIPTS_DIR="$(dirname "$(readlink -f "$0")")"
# shellcheck source=scripts/common
source "${SCRIPTS_DIR}/common"

# Build Oak server.
"${SCRIPTS_DIR}/build_server_dev" "$@"

# TODO: Ensure that background processes are killed with something like `trap cleanup_fn EXIT`.

# Run Rust-based Oak examples against a common Oak server instance.
# TODO(#594): Re-enable rustfmt when upstream rustc internal error is fixed.
readonly RUST_EXAMPLES="$(find examples -mindepth 2 -maxdepth 4 -type d -regex '.*/module.*/rust$' | cut -d'/' -f2 | uniq | grep -v rustfmt)"
for example in ${RUST_EXAMPLES}; do
  # Running `build_example` to compile application configurations before running the server.
  "${SCRIPTS_DIR}/build_example" "${example}"
  ./bazel-clang-bin/oak/server/dev/dev_oak_runner \
    --config="${PWD}/bazel-client-bin/examples/${example}/config/config.bin" &
  local rust_example_pid=$!
  sleep 2  # Wait for an application to start.
  # Currently `chat` application starts an infinite loop, so `run_examples` just checks
  # if the module can be loaded correctly.
  if [[ "chat" == "${example}" ]]; then
    "${SCRIPTS_DIR}/run_example" -C --test "${example}"
  else
    "${SCRIPTS_DIR}/run_example" "${example}"
  fi
  # TODO: Ensure that background processes are killed with something like `trap cleanup_fn EXIT`.
  kill -s SIGTERM "${rust_example_pid}"
done

# Run C++-based Oak examples.
readonly CPP_EXAMPLES="$(find examples -mindepth 2 -maxdepth 4 -type d -regex '.*/module.*/cpp$' | cut -d'/' -f2 | uniq)"

for example in ${CPP_EXAMPLES}; do
  "${SCRIPTS_DIR}/build_example" "${example}"
  # TensorFlow example is compiled with Emscripten and other examples with Clang.
  if [[ "tensorflow" == "${example}" ]]; then
    ./bazel-clang-bin/oak/server/dev/dev_oak_runner \
      --config="${PWD}/bazel-emscripten-bin/examples/${example}/config/config_cpp.bin" &
  else
    ./bazel-clang-bin/oak/server/dev/dev_oak_runner \
      --config="${PWD}/bazel-wasm-bin/examples/${example}/config/config_cpp.bin" &
  fi
  local cpp_example_pid=$!
  sleep 2  # Wait for an application to start.
  "${SCRIPTS_DIR}/run_example" "${example}"
  kill -s SIGTERM "${cpp_example_pid}"
done

# Special case: run the hello_world example with:
#  - a storage provider
#  - a configured translator module.
./bazel-clang-bin/oak/server/dev/dev_oak_runner \
  --config="${PWD}/bazel-client-bin/examples/hello_world/config/config_translator.bin" &
local storage_example_pid=$!
./bazel-clang-bin/oak/server/storage/storage_server &
local storage_server_pid=$!
sleep 2  # Wait for an application to start.
"${SCRIPTS_DIR}/run_example" "hello_world"
kill -s SIGTERM "${storage_server_pid}" "${storage_example_pid}"
