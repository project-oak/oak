#!/usr/bin/env bash

readonly SCRIPTS_DIR="$(dirname "$0")"
# shellcheck source=scripts/common
source "$SCRIPTS_DIR/common"

# Git submodule where the Android trusted root certificates are stored.
readonly SUBMODULE_DIR="${SCRIPTS_DIR}/../ca-certificates"

# Generated file.
readonly TARGET_FILE="${SCRIPTS_DIR}/../oak/server/rust/oak_loader/src/certs/roots.pem"

if [[ -f "${TARGET_FILE}" ]]; then
    rm "${TARGET_FILE}"
fi

files="$(find ./"${SUBMODULE_DIR}"/files/*)"

# Concatenate all the files into a single PEM-encoded file.
# A PEM file can contain multiple certificates, each with its own header and footer.
#
# See: https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail
for file in ${files}; do
    # Append the issuer as a comment and the PEM encoded certificate content to the target file.
    { echo "# $(openssl x509 -in "${file}" --noout --issuer)"; \
        openssl x509 -in "${file}"; echo ""; } >> "${TARGET_FILE}"
done
