#!/usr/bin/env bash

DOCKER_IMAGE_VERSION=":latest"
DOCKER_IMAGE_TAG=":latest"
while getopts "d:h" opt; do
  case "${opt}" in
    h)
      echo -e "Usage: ${0} [-h] -d DIGEST

Build Oak dev Docker image.

Options:
  -d    Docker image digest
        If digest is not specified - the 'latest' tag is used instead
  -h    Print Help (this message) and exit"
      exit 0;;
    d)
      DOCKER_IMAGE_VERSION="@${OPTARG}"
      DOCKER_IMAGE_TAG="";;
    *)
      echo "Invalid argument: ${OPTARG}"
      exit 1;;
  esac
done

readonly SCRIPTS_DIR="$(dirname "${0}")"
# shellcheck source=scripts/common
source "${SCRIPTS_DIR}/common"

# The default user for a Docker container has uid 0 (root). To avoid creating
# root-owned files in the build directory we tell Docker to use the current user
# ID, if known.
# See
# https://github.com/googleapis/google-cloud-cpp/blob/a186208b79d900b4ec71c6f9df3acf7638f01dc6/ci/kokoro/docker/build.sh#L147-L152
readonly DOCKER_UID="${UID:-0}"
readonly DOCKER_GID="$(id -g)"

docker build \
  --cache-from="${DOCKER_IMAGE_NAME}${DOCKER_IMAGE_VERSION}" \
  --tag="${DOCKER_IMAGE_NAME}${DOCKER_IMAGE_TAG}" \
  --build-arg=USER_UID="${DOCKER_UID}" \
  --build-arg=USER_GID="${DOCKER_GID}" \
  . 1>&2
