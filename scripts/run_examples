#!/usr/bin/env bash

set -o errexit
set -o nounset

readonly DOCKER_UID="${UID:-0}"
readonly DOCKER_GID="${GID:-0}"
readonly DOCKER_USER="${USER:-root}"

readonly SCRIPTS_DIR="$(dirname "$0")"

# Build Oak server.
"$SCRIPTS_DIR/build_server_docker"

# Run Rust-based Oak examples, each with their own Oak server instance.
readonly RUST_EXAMPLES="$(find examples -mindepth 2 -maxdepth 4 -type d -regex '.*/module/rust$' | cut -d'/' -f2)"
for example in ${RUST_EXAMPLES}; do
  container_id=$("$SCRIPTS_DIR/docker_run" --detach ./bazel-bin/oak/server/asylo/oak)
  "${SCRIPTS_DIR}/docker_run" "${SCRIPTS_DIR}/run_example" "${example}"
  docker stop "$container_id"
done

# Run C++-based Oak examples.
readonly CPP_EXAMPLES="$(find examples -mindepth 2 -maxdepth 4 -type d -regex '.*/module/cpp$' | cut -d'/' -f2)"
for example in ${CPP_EXAMPLES}; do
  container_id=$("$SCRIPTS_DIR/docker_run" --detach ./bazel-bin/oak/server/asylo/oak)
  "${SCRIPTS_DIR}/docker_run" "${SCRIPTS_DIR}/run_example" -c "${example}"
  docker stop "$container_id"
done
