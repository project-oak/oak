#!/usr/bin/env bash

set -o errexit
set -o nounset

readonly DOCKER_UID="${UID:-0}"
readonly DOCKER_GID="${GID:-0}"
readonly DOCKER_USER="${USER:-root}"

readonly SCRIPTS_DIR="$(dirname "$0")"

# Run Oak server.
"$SCRIPTS_DIR/build_server_docker"
readonly SERVER_CONTAINER_ID=$("$SCRIPTS_DIR/docker_run" \
  --detach \
  ./bazel-bin/oak/server/asylo/oak)

# Run Rust-based Oak examples.
readonly RUST_EXAMPLES="$(find examples -mindepth 2 -maxdepth 4 -type d -regex '.*/module/rust$' | cut -d'/' -f2)"
for example in ${RUST_EXAMPLES}; do
  "${SCRIPTS_DIR}/docker_run" "${SCRIPTS_DIR}/run_example" "${example}"
done
# Run C++-based Oak examples.
readonly CPP_EXAMPLES="$(find examples -mindepth 2 -maxdepth 4 -type d -regex '.*/module/cpp$' | cut -d'/' -f2)"
for example in ${CPP_EXAMPLES}; do
  "${SCRIPTS_DIR}/docker_run" "${SCRIPTS_DIR}/run_example" -c "${example}"
done

docker stop "$SERVER_CONTAINER_ID"
