#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o xtrace

# For each Rust workspace, first run tests, then run clippy, turning warnings into errors.
# See https://github.com/rust-lang/rust-clippy.

cargo test --all-targets --manifest-path=./rust/Cargo.toml
cargo clippy --all-targets --manifest-path=./rust/Cargo.toml -- --deny=warnings

cargo test --all-targets --manifest-path=./examples/Cargo.toml
cargo clippy --all-targets --manifest-path=./examples/Cargo.toml -- --deny=warnings

# Use the remote cache, assuming it is publicly readable.
# See https://pantheon.corp.google.com/storage/browser/oak-bazel-cache?project=oak-ci
bazel_test_flags=(
    '--remote_cache=https://storage.googleapis.com/oak-bazel-cache'
    '--test_output=all'
)

bazel test "${bazel_test_flags[@]}" \
  //oak/server:host_tests \
  //oak/server/storage:host_tests \
  //oak/common:host_tests
