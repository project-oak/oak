# Trusted Travel Agent Demo

This demo showcases the use of Oak Functions for privacy-preserving data lookups
in a simulated travel planning application. It includes example data for
flights, hotels, and activities, along with the necessary tools to process this
data and deploy the required infrastructure.

The core idea is to demonstrate how a client can query sensitive data (like
flight, hotel, or activity availability) without the server learning the query
itself, and while ensuring the server is running on a secure, attested platform.

## Files and Directories

- **`create_lookup_data.py`**: A Python script that transforms raw JSON data
  into the `LookupDataChunk` textproto format required by Oak Functions. It
  aggregates data from multiple input files, groups entries by a primary key,
  and formats the output correctly.

- **`raw/*.json`**: These files contain the raw, human-readable sample data for
  the demo.

  - `london_madrid.json`: Example flight data.
  - `hotels.json`: Example hotel information.
  - `hotels_availability.json`: Example hotel availability data.
  - `activities.json`: Example activity data.

- **`*.textproto`**: Intermediate Protobuf text format files generated by the
  `create_lookup_data.py` script. These are human-readable representations of
  the serialized data.

  - `flights.textproto`
  - `hotels.textproto`
  - `activities.textproto`

- **`prompt.md`**: This file contains the structured prompts and JSON schemas
  that were used to generate the sample `.json` data. It serves as a reference
  for the data's structure and origin.

- **`terraform/`**: This directory contains the Terraform configuration for
  deploying the entire demo infrastructure on Google Cloud Platform (GCP). This
  includes:
  - An Oak Functions Standalone instance for each database (flights, hotels,
    activities).
  - An Attested MCP (Model Control Protocol) server that acts as a frontend to
    each Oak Functions instance.
  - **Oak Proxy Clients**: For each MCP server, an individual Oak Proxy client
    is deployed. These proxies allow clients that cannot perform remote
    attestation to connect to the MCP server under the assumption that they
    trust the proxy.
  - The necessary firewall rules and networking.

## Demo Workflow

1. **Data Generation**: The initial step is to generate the raw JSON data using
   the [AI Studio](https://aistudio.google.com/) with configured structured
   output. Corresponding prompts are available in the [prompts.md](./prompts.md)
   file.

2. **Data Transformation**: The `create_lookup_data.py` script is used to
   process the raw JSON files. This script reads the input JSON, aggregates the
   data by the defined `key` (e.g., `CITY` for hotels, `CITY:DATE` for
   availability), and writes the output to a `.textproto` file.

   Generate lookup data using the following commands:

   ```bash
   python3 mcp/demo/create_lookup_data.py --input mcp/demo/data/flights.json --output mcp/demo/data/flights.textproto
   python3 mcp/demo/create_lookup_data.py --input mcp/demo/data/hotels.json mcp/demo/data/hotels_availability.json --output mcp/demo/data/hotels.textproto
   python3 mcp/demo/create_lookup_data.py --input mcp/demo/data/activities.json --output mcp/demo/data/activities.textproto
   ```

3. **Binary Conversion**: The `.textproto` files are then converted into the
   binary format that Oak Functions can load. This is typically done with a tool
   like `gqui`.

   ```bash
   gqui from textproto:mcp/demo/data/flights.textproto proto oak.functions.LookupDataChunk --outfile=rawproto:mcp/demo/data/flights.binarypb
   gqui from textproto:mcp/demo/data/hotels.textproto proto oak.functions.LookupDataChunk --outfile=rawproto:mcp/demo/hotels.binarypb
   gqui from textproto:mcp/demo/data/activities.textproto proto oak.functions.LookupDataChunk --outfile=rawproto:mcp/demo/activities.binarypb
   ```

4. **Deployment**: The Terraform configuration in the `terraform/` directory is
   used to deploy the necessary GCP resources, including the Oak Functions
   Standalone instances, MCP servers, and Oak Proxy clients. It points to the
   `.binarypb` files (usually hosted in a GCS bucket) to be used as the lookup
   data.

5. **Querying**: Once deployed, you can interact with the MCP server (either
   directly if attestation is supported, or via the Oak Proxy client) by sending
   it encrypted queries. The server forwards the query to the Oak Functions
   enclave, which performs the lookup and returns the result, all without
   revealing the query content to the server itself.
