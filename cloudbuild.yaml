# Reference: https://cloud.google.com/cloud-build/docs/build-config

steps:
  # Pull pre-existing latest Docker image.
  - name: 'gcr.io/cloud-builders/docker'
    id: pull_image
    waitFor: ['-']
    timeout: 10m
    args: ['pull', 'gcr.io/oak-ci/oak:latest']
  # Build Docker image based on current Dockerfile, if necessary.
  - name: 'gcr.io/cloud-builders/docker'
    id: build_image
    waitFor: ['pull_image']
    timeout: 20m
    args:
      [
        'build',
        '--pull',
        '--cache-from=gcr.io/oak-ci/oak:latest',
        '--tag=gcr.io/oak-ci/oak:latest',
        '.',
      ]
  # Run next build steps inside the newly created Docker image.
  # See: https://cloud.google.com/cloud-build/docs/create-custom-build-steps
  # Init .git repository used by check_generated
  # Workaround for https://github.com/GoogleCloudPlatform/cloud-builders/issues/236
  - name: 'gcr.io/oak-ci/oak:latest'
    id: git_init
    entrypoint: 'bash'
    waitFor: ['build_image']
    timeout: 5m
    args: ['./scripts/git_init']

  # Make sure that the Bazel server is unpacked and initialized, by calling `bazel info` (any other
  # Bazel command would probably do).
  - name: 'gcr.io/oak-ci/oak:latest'
    id: bazel_init
    entrypoint: 'bazel'
    waitFor: ['git_init']
    timeout: 5m
    args: ['info']

  - name: 'gcr.io/oak-ci/oak:latest'
    id: run_tests_tsan
    waitFor: ['bazel_init']
    timeout: 60m
    entrypoint: 'bash'
    args: ['./scripts/run_tests_tsan']

  - name: 'gcr.io/oak-ci/oak:latest'
    id: run_tests_tsan_2
    waitFor: ['run_tests_tsan']
    timeout: 60m
    entrypoint: 'bash'
    args: ['./scripts/run_tests_tsan']

  - name: 'gcr.io/oak-ci/oak:latest'
    id: run_tests_tsan_3
    waitFor: ['run_tests_tsan_2']
    timeout: 60m
    entrypoint: 'bash'
    args: ['./scripts/run_tests_tsan']

  - name: 'gcr.io/oak-ci/oak:latest'
    id: run_tests_tsan_4
    waitFor: ['run_tests_tsan_3']
    timeout: 60m
    entrypoint: 'bash'
    args: ['./scripts/run_tests_tsan']

timeout: 2h

options:
  env:
    # This variable is only defined in the `merge` GCB trigger,
    # and contains GCB credentials for updating the Bazel cache.
    - 'BAZEL_GOOGLE_CREDENTIALS=$_BAZEL_GOOGLE_CREDENTIALS'
  # See: https://cloud.google.com/cloud-build/docs/api/reference/rest/Shared.Types/MachineType
  machineType: 'N1_HIGHCPU_32'
  requestedVerifyOption: 'VERIFIED'
  sourceProvenanceHash: ['SHA256']
